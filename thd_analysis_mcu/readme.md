# THD 分析仪 (谐波失真分析系统)

## 项目介绍

这是一个基于 MSP 微控制器的谐波分析系统，可以对输入的模拟信号进行采样、FFT 分析，计算总谐波失真(THD)，并自动识别波形类型。系统支持两种工作模式：触发模式和自动模式，并通过 UART 接口进行控制和数据传输。

主要功能：

- 实时采集模拟信号并进行 FFT 分析
- 计算信号的总谐波失真(THD)及各次谐波幅度
- 自动识别波形类型(正弦波、方波、三角波、锯齿波等)
- 通过 UART 接口接收指令和发送分析结果
- 支持触发和自动两种采样模式

## UART 通信协议

### 命令包格式

每个命令包固定为 8 字节，格式如下：

| 字节 0 | 字节 1 | 字节 2 | 字节 3 | 字节 4 | 字节 5 | 字节 6 | 字节 7 |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 包头   | 命令码 | 数据 0 | 数据 1 | 数据 2 | 数据 3 | 数据 4 | 包尾   |
| 0xAA   | CMD    | DATA   | DATA   | DATA   | DATA   | DATA   | 0x55   |

- 包头：固定为`0xAA`
- 命令码：具体命令的编码
- 数据字节：根据命令不同，可能包含不同的数据
- 包尾：固定为`0x55`

### 响应包格式

每个响应包固定为 8 字节，格式如下：

| 字节 0 | 字节 1 | 字节 2 | 字节 3 | 字节 4 | 字节 5 | 字节 6 | 字节 7 |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 包头   | 命令码 | 状态码 | 数据 0 | 数据 1 | 数据 2 | 数据 3 | 包尾   |
| 0xAA   | CMD    | STATUS | DATA   | DATA   | DATA   | DATA   | 0x55   |

- 包头：固定为`0xAA`
- 命令码：回显收到的命令码
- 状态码：表示命令执行结果
- 数据字节：返回的数据，32 位整数，低字节在前
- 包尾：固定为`0x55`

### 分析结果数据包格式

分析结果数据包由三部分组成：包头、数据内容和包尾。

包头格式(8 字节)：

```
0xAA 0x55 0xA5 0x5A 0xAA [样本大小低字节] [样本大小高字节] [谐波数量]
```

包尾格式(5 字节)：

```
0xBB 0x66 0xB6 0x6B 0xBB
```

数据内容包括：

1. ADC 原始采样数据(SAMPLE_SIZE \* 2 字节)
2. THD 值(4 字节浮点数)
3. 归一化谐波幅度(每个谐波 4 字节浮点数 \* NUM_HARMONICS)
4. 谐波索引(每个谐波 4 字节整数 \* NUM_HARMONICS)
5. 基波频率(4 字节整数)
6. 波形类型(1 字节)
7. 直流偏移标志(1 字节布尔值)

## 分析结果结构体详解

系统内部使用的`AnalysisResult`结构体包含了信号分析的全部结果，详细如下：

| 字段名                          | 类型         | 大小(字节)        | 说明                                                                                                                                                                                                                                                                               |
| ------------------------------- | ------------ | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| thd                             | float        | 4                 | 总谐波失真，以百分比表示，数值范围一般为 0-100%。表示非基频谐波功率与基波功率的比值。值越小表示信号越纯净。                                                                                                                                                                        |
| normalized_harmonics_amplitudes | float[]      | 4 × NUM_HARMONICS | 归一化后的各次谐波幅度值数组。索引 0 存储基波(归一化为 1.0)，索引 1 存储二次谐波相对于基波的幅度比，索引 2 存储三次谐波的幅度比，依此类推。通过这些值可以分析信号的谐波组成。                                                                                                      |
| harmonic_indices                | uint32_t[]   | 4 × NUM_HARMONICS | 各次谐波在 FFT 频谱中的索引位置。索引 0 存储基波在 FFT 结果中的位置，索引 1 存储二次谐波的位置，依此类推。这些索引可用于在 FFT 结果中准确定位每个谐波。                                                                                                                            |
| fundamental_freq                | uint32_t     | 4                 | 检测到的信号基波频率，单位为 Hz。此值反映了输入信号的主要频率成分。                                                                                                                                                                                                                |
| waveform                        | WaveformType | 1                 | 波形类型枚举值，表示自动识别的波形类型。可能的值包括：<br>0 - 无有效波形(WAVEFORM_NONE)<br>1 - 直流信号(WAVEFORM_DC)<br>2 - 正弦波(WAVEFORM_SINE)<br>3 - 方波(WAVEFORM_SQUARE)<br>4 - 三角波(WAVEFORM_TRIANGLE)<br>5 - 锯齿波(WAVEFORM_SAWTOOTH)<br>6 - 未知波形(WAVEFORM_UNKNOWN) |
| has_dc_offset                   | bool         | 1                 | 直流偏移标志，true 表示信号存在明显的 DC 偏移分量，false 表示信号基本居中在 0V 附近。这有助于判断信号是否有直流偏置。                                                                                                                                                              |

### 结构体内存布局

`AnalysisResult`结构体总大小为: 4 + (4 × NUM_HARMONICS) + (4 × NUM_HARMONICS) + 4 + 1 + 1 字节。

### 结构体的用途

此结构体在以下场景中使用：

1. 作为分析算法的返回值，包含完整的谐波分析结果
2. 在通过 UART 发送分析结果前，用于组织和准备数据
3. 可用于保存历史分析记录，进行趋势对比分析

## 可用 UART 命令

### 1. 设置自动模式 (0x01)

**命令格式**：

```
0xAA 0x01 0x00 0x00 0x00 0x00 0x00 0x55
```

**可能的响应**：

- 成功：`0xAA 0x01 0x00 0x01 0x00 0x00 0x00 0x55` (MODE_AUTO=1)
- 注意：此命令总是成功

### 2. 设置触发模式 (0x02)

**命令格式**：

```
0xAA 0x02 0x00 0x00 0x00 0x00 0x00 0x55
```

**可能的响应**：

- 成功：`0xAA 0x02 0x00 0x02 0x00 0x00 0x00 0x55` (MODE_TRIGGER=2)
- 注意：此命令总是成功

### 3. 获取当前模式状态 (0x03)

**命令格式**：

```
0xAA 0x03 0x00 0x00 0x00 0x00 0x00 0x55
```

**可能的响应**：

- 自动模式：`0xAA 0x03 0x00 0x01 0x00 0x00 0x00 0x55` (MODE_AUTO=1)
- 触发模式：`0xAA 0x03 0x00 0x02 0x00 0x00 0x00 0x55` (MODE_TRIGGER=2)

### 4. 触发一次采样 (0x04)

**命令格式**：

```
0xAA 0x04 0x00 0x00 0x00 0x00 0x00 0x55
```

**可能的响应**：

- 成功：`0xAA 0x04 0x00 0x00 0x00 0x00 0x00 0x55`
- 系统忙：`0xAA 0x04 0x02 0x00 0x00 0x00 0x00 0x55`
- 错误(非触发模式)：`0xAA 0x04 0x01 0x00 0x00 0x00 0x00 0x55`

### 5. 设置自动模式延时时间 (0x05)

**命令格式**：

```
0xAA 0x05 [延时低字节] [延时高字节] 0x00 0x00 0x00 0x55
```

其中，延时值为 16 位整数，表示自动模式下两次采样之间的延时毫秒数。必须在 100-10000 之间。

**可能的响应**：

- 成功：`0xAA 0x05 0x00 [延时低字节] [延时高字节] 0x00 0x00 0x55`
- 错误(参数超出范围)：`0xAA 0x05 0x01 0x00 0x00 0x00 0x00 0x55`

### 6. 获取自动模式延时时间 (0x06)

**命令格式**：

```
0xAA 0x06 0x00 0x00 0x00 0x00 0x00 0x55
```

**可能的响应**：

- 成功：`0xAA 0x06 0x00 [延时低字节] [延时高字节] 0x00 0x00 0x55`
  例如，默认 1000ms：`0xAA 0x06 0x00 0xE8 0x03 0x00 0x00 0x55` (0x03E8 = 1000)

## 响应状态码含义

- `0x00`：操作成功(RESP_OK)
- `0x01`：操作失败(RESP_ERROR)
- `0x02`：系统忙(RESP_BUSY)

## 波形类型编码

分析结果中的波形类型使用以下编码：

- `0x00`：无有效波形(WAVEFORM_NONE)
- `0x01`：直流信号(WAVEFORM_DC)
- `0x02`：正弦波(WAVEFORM_SINE)
- `0x03`：方波(WAVEFORM_SQUARE)
- `0x04`：三角波(WAVEFORM_TRIANGLE)
- `0x05`：锯齿波(WAVEFORM_SAWTOOTH)
- `0x06`：未知波形(WAVEFORM_UNKNOWN)

## 使用示例

1. **初始化连接**：

   - 连接设备
   - 配置 UART（波特率 115200，8 位数据，无奇偶校验，1 位停止位）

2. **设置为触发模式**：

   - 发送：`0xAA 0x02 0x00 0x00 0x00 0x00 0x00 0x55`
   - 预期响应：`0xAA 0x02 0x00 0x02 0x00 0x00 0x00 0x55`

3. **触发一次采样和分析**：

   - 发送：`0xAA 0x04 0x00 0x00 0x00 0x00 0x00 0x55`
   - 预期响应：`0xAA 0x04 0x00 0x00 0x00 0x00 0x00 0x55`
   - 接收分析结果数据包

4. **设置为自动模式，间隔 2000ms**：
   - 发送：`0xAA 0x05 0xD0 0x07 0x00 0x00 0x00 0x55` (0x07D0 = 2000)
   - 预期响应：`0xAA 0x05 0x00 0xD0 0x07 0x00 0x00 0x55`
   - 发送：`0xAA 0x01 0x00 0x00 0x00 0x00 0x00 0x55`
   - 预期响应：`0xAA 0x01 0x00 0x01 0x00 0x00 0x00 0x55`
   - 系统将自动每 2000ms 执行一次采样分析并发送结果
